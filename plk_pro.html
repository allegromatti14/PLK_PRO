<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MatiPLK – Predictor</title>
  <style>
    :root { --bg:#0b0b0b; --card:#151515; --border:#2b2b2b; --muted:#aaa; --accent:#ff9800; --ok:#6CFF6C; --bad:#ff4444; }
    body{margin:0;background:var(--bg);color:#fff;font-family:Arial;padding:16px}
    h1{font-size:28px;margin:12px 0;text-align:center}
    .sub{color:var(--muted);text-align:center;margin-top:-6px}
    .card{background:var(--card);border:1px solid var(--border);padding:14px;border-radius:16px;margin-top:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    label{display:block;margin-top:10px;color:#ddd}
    select,input,button{width:100%;padding:12px;margin-top:6px;font-size:16px;border-radius:12px;border:1px solid var(--border);background:#111;color:#fff}
    button{background:var(--accent);border:none;color:#111;font-weight:800;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .ok{color:var(--ok);border-color:rgba(108,255,108,.35)}
    .bad{color:var(--bad);border-color:rgba(255,68,68,.35)}
    .muted{color:var(--muted)}
    a{color:#9ad0ff}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .tabs{display:flex;gap:10px;margin-top:12px}
    .tabbtn{flex:1;padding:12px;border-radius:14px;border:1px solid var(--border);background:#111;color:#fff;font-weight:800;cursor:pointer}
    .tabbtn.active{background:var(--accent);color:#111;border-color:transparent}
    .hidden{display:none}
    .hint{margin-top:8px;color:var(--muted);text-align:center}
  </style>
</head>
<body>
  <h1>MatiPLK – PLK Predictor</h1>
  <div class="sub" id="subline">Do zabawy • działa na GitHub Pages</div>

  <div class="tabs">
    <button class="tabbtn active" id="tabTeam" type="button">Drużyna</button>
    <button class="tabbtn" id="tabRound" type="button">Kolejka 1–30</button>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <b>Terminarz</b>
        <span id="meta" class="pill muted">—</span>
      </div>
      <span id="net" class="pill">—</span>
    </div>

    <div id="panelTeam">
      <label>Wybierz drużynę</label>
      <select id="team"></select>

      <label>Mecze tej drużyny (u siebie i wyjazd)</label>
      <select id="matchTeam">
        <option value="">Ładowanie…</option>
      </select>
    </div>

    <div id="panelRound" class="hidden">
      <label>Wybierz kolejkę (1–30)</label>
      <select id="roundPick"></select>

      <label>Mecze w tej kolejce</label>
      <select id="matchRound">
        <option value="">Ładowanie…</option>
      </select>

      <div class="hint">Tip: po wyborze kolejki wybierz mecz z listy – ustawimy szczegóły automatycznie.</div>
    </div>

    <div class="row">
      <div style="flex:1;min-width:220px">
        <label>Gospodarz</label>
        <input id="home" readonly />
      </div>
      <div style="flex:1;min-width:220px">
        <label>Gość</label>
        <input id="away" readonly />
      </div>
    </div>

    <label>Data i godzina meczu</label>
    <input id="when" readonly />

    <div class="row">
      <div style="flex:1;min-width:220px">
        <label>Status</label>
        <input id="status" readonly />
      </div>
      <div style="flex:1;min-width:220px">
        <label>TV</label>
        <input id="tv" readonly />
      </div>
    </div>

    <button id="btn" disabled>ANALIZUJ</button>

    <div class="muted" style="text-align:center;margin-top:10px">
      Źródło aktualizacji: <a href="https://plk.pl/terminarz" target="_blank" rel="noreferrer">plk.pl/terminarz</a>
    </div>
  </div>

  <div class="card" id="out">
    <b>Wynik</b>
    <div class="muted">Wybierz mecz i kliknij ANALIZUJ.</div>
  </div>

<script>
  function norm(s){ return String(s||"").trim().replace(/\s+/g," ").replace(/[–—]/g,"-"); }

  let TEAMS=null;
  let MATCHES=[];
  let META=null;

  function netPill(){
    const el=document.getElementById('net');
    const on=navigator.onLine;
    el.textContent = on ? "ONLINE" : "OFFLINE";
    el.className = "pill " + (on ? "ok" : "bad");
  }

  async function loadJSON(path){
    const r = await fetch(path, {cache:'no-store'});
    if(!r.ok) throw new Error(path+" HTTP "+r.status);
    return await r.json();
  }

  function setMeta(){
    const el=document.getElementById('meta');
    if(META?.updated_at) el.textContent = "aktualizacja: " + META.updated_at;
    else el.textContent = "mecze: " + MATCHES.length;
  }

  function clearMatchUI(msg){
    document.getElementById('home').value = "";
    document.getElementById('away').value = "";
    document.getElementById('when').value = "";
    document.getElementById('status').value = "";
    document.getElementById('tv').value = "";
    document.getElementById('btn').disabled = true;
    document.getElementById('out').innerHTML = `<b>Wynik</b><div class="muted">${msg}</div>`;
  }

  function fillTeams(){
    const sel=document.getElementById('team');
    sel.innerHTML="";
    Object.keys(TEAMS).forEach(t=> sel.innerHTML += `<option value="${t}">${t}</option>`);
  }

  function fillRounds(){
    const rp=document.getElementById('roundPick');
    rp.innerHTML="";
    for(let i=1;i<=30;i++){
      rp.innerHTML += `<option value="${i}">Kolejka ${i}</option>`;
    }
  }

  function fmtWhen(iso){
    const d=new Date(iso);
    return d.toLocaleString('pl-PL', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
  }

  function formatOptForTeam(m, team){
    const when = fmtWhen(m.start);
    const isHome = norm(m.home)===norm(team);
    const vs = isHome ? `vs ${m.away} (u siebie)` : `@ ${m.home} (wyjazd)`;
    const score = (m.status==="played" && m.score) ? ` ${m.score.home}:${m.score.away}` : "";
    const r = m.round ? ` | kolejka ${m.round}` : "";
    return `${when} — ${vs}${score}${r}`;
  }

  function formatOptForRound(m){
    const when = fmtWhen(m.start);
    const score = (m.status==="played" && m.score) ? ` ${m.score.home}:${m.score.away}` : "";
    return `${when} — ${m.home} vs ${m.away}${score}`;
  }

  function applyMatchById(id){
    const m = MATCHES.find(x => String(x.id)===String(id));
    if(!m){ clearMatchUI("Brak meczu w danych."); return; }
    document.getElementById('home').value = m.home || "";
    document.getElementById('away').value = m.away || "";
    document.getElementById('when').value = new Date(m.start).toLocaleString('pl-PL');
    document.getElementById('status').value = m.status || "scheduled";
    document.getElementById('tv').value = m.tv || "";
    document.getElementById('btn').disabled = false;
  }

  function buildListForTeam(){
    const team=document.getElementById('team').value;
    const sel=document.getElementById('matchTeam');
    sel.innerHTML = `<option value="">— wybierz mecz —</option>`;

    const list = MATCHES
      .filter(m => norm(m.home)===norm(team) || norm(m.away)===norm(team))
      .sort((a,b)=> new Date(a.start)-new Date(b.start));

    if(list.length===0){
      sel.innerHTML = `<option value="">Brak meczów w danych (uruchom workflow w Actions)</option>`;
      clearMatchUI("Brak meczów dla tej drużyny.");
      return;
    }

    for(const m of list){
      sel.innerHTML += `<option value="${m.id}">${formatOptForTeam(m, team)}</option>`;
    }

    const now = new Date();
    const future = list.find(x => new Date(x.start) > now) || list[0];
    sel.value = future.id;
    applyMatchById(future.id);
  }

  function buildListForRound(){
    const roundNo = Number(document.getElementById('roundPick').value);
    const sel=document.getElementById('matchRound');
    sel.innerHTML = `<option value="">— wybierz mecz —</option>`;

    const list = MATCHES
      .filter(m => Number(m.round) === roundNo)
      .sort((a,b)=> new Date(a.start)-new Date(b.start));

    if(list.length===0){
      sel.innerHTML = `<option value="">Brak meczów w tej kolejce (może aktualizacja jeszcze nie pobrała)</option>`;
      clearMatchUI("Brak meczów w tej kolejce.");
      return;
    }

    for(const m of list){
      sel.innerHTML += `<option value="${m.id}">${formatOptForRound(m)}</option>`;
    }

    const now = new Date();
    const future = list.find(x => new Date(x.start) > now) || list[0];
    sel.value = future.id;
    applyMatchById(future.id);
  }

  function scoreTeam(teamName, isHome){
    const t=TEAMS[teamName];
    if(!t) return 50;
    const base = Number(t.rating||80);
    const form = (t.form||[1,0,1,0,1]).reduce((a,v)=>a+v,0)/5*20;
    const players = (t.top_players||[]).reduce((s,p)=>s+(p.ppg*0.5+p.rpg*0.3+p.apg*0.2),0)*0.4;
    const homeBonus = isHome ? 6 : 0;
    const rand = Math.random()*3;
    return base+form+players+homeBonus+rand;
  }

  function predict(){
    const isTeam = !document.getElementById('panelTeam').classList.contains('hidden');
    const id = isTeam ? document.getElementById('matchTeam').value : document.getElementById('matchRound').value;
    const m = MATCHES.find(x => String(x.id)===String(id));
    if(!m){ return; }

    const sh=scoreTeam(m.home,true);
    const sa=scoreTeam(m.away,false);
    const diff=sh-sa;
    const win = diff>0 ? m.home : m.away;
    const pct = Math.min(80, 50 + Math.abs(diff)*2.3);
    const played = (m.status==="played" && m.score) ? `<br><b>Wynik:</b> ${m.score.home}:${m.score.away} (wygrał: ${m.winner})` : "";
    document.getElementById('out').innerHTML = `
      <b>Wynik analizy</b><br>
      <span class="mono">${m.home}</span>: ${sh.toFixed(1)}<br>
      <span class="mono">${m.away}</span>: ${sa.toFixed(1)}<br><br>
      <b>Typ:</b> ${win}<br>
      <b>Szanse:</b> ${pct.toFixed(0)}%${played}
      <br><span class="muted">Do zabawy</span>
    `;
  }

  function setTab(which){
    const isTeam = which === 'team';
    document.getElementById('tabTeam').classList.toggle('active', isTeam);
    document.getElementById('tabRound').classList.toggle('active', !isTeam);
    document.getElementById('panelTeam').classList.toggle('hidden', !isTeam);
    document.getElementById('panelRound').classList.toggle('hidden', isTeam);

    clearMatchUI("Wybierz mecz i kliknij ANALIZUJ.");
    if(isTeam) buildListForTeam(); else buildListForRound();
  }

  (async () => {
    netPill();
    window.addEventListener('online', netPill);
    window.addEventListener('offline', netPill);

    try{
      TEAMS = await loadJSON('teams.json');
      const data = await loadJSON('matches.json');
      if(Array.isArray(data)){ MATCHES=data; META=null; }
      else { META=data.meta||null; MATCHES=data.matches||[]; }
      setMeta();
      fillTeams();
      fillRounds();
      document.getElementById('subline').textContent = `Wczytano mecze: ${MATCHES.length}`;

      buildListForTeam();
      buildListForRound();
      setTab('team');
    }catch(e){
      console.warn(e);
      document.getElementById('subline').textContent = "Błąd wczytywania danych";
      clearMatchUI("OFFLINE / brak danych (sprawdź pliki w repo)");
      document.getElementById('net').textContent = "OFFLINE";
      document.getElementById('net').className = "pill bad";
      return;
    }

    document.getElementById('team').addEventListener('change', buildListForTeam);
    document.getElementById('matchTeam').addEventListener('change', (e)=> applyMatchById(e.target.value));
    document.getElementById('roundPick').addEventListener('change', buildListForRound);
    document.getElementById('matchRound').addEventListener('change', (e)=> applyMatchById(e.target.value));
    document.getElementById('btn').addEventListener('click', predict);
    document.getElementById('tabTeam').addEventListener('click', ()=> setTab('team'));
    document.getElementById('tabRound').addEventListener('click', ()=> setTab('round'));
  })();
</script>
</body>
</html>
