<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>MatiPLK – PLK Predictor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{background:#0b0b0b;color:#fff;font-family:Arial;padding:15px}
  h2,h3{text-align:center;margin:10px 0}
  select,input,button{width:100%;padding:12px;margin:8px 0;font-size:16px;border-radius:10px;border:1px solid #333;background:#111;color:#fff}
  button{background:#ff9800;border:none;font-weight:bold;color:#111;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .box{background:#151515;padding:14px;border-radius:14px;margin-top:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  small{color:#aaa}
  #status{text-align:center;margin:10px 0;font-weight:bold}
  .ok{color:#6CFF6C}
  .bad{color:#ff4444}
  a{color:#9ad0ff}
</style>
</head>
<body>

<h2>MatiPLK – PLK Predictor</h2>
<div id="status" class="bad">Ładowanie danych…</div>

<div class="box">
  <h3>Wybór meczu</h3>

  <label>Drużyna A (gospodarz)</label>
  <select id="teamA"></select>

  <label>Mecz gospodarza (terminarz)</label>
  <select id="matchSelect">
    <option value="">— wybierz mecz —</option>
  </select>

  <label>Drużyna B (gość)</label>
  <select id="teamB"></select>

  <label>Data i godzina meczu</label>
  <input id="matchDate" type="datetime-local" readonly>

  <button id="btnPredict" onclick="predict()" disabled>ANALIZUJ</button>

  <div style="text-align:center;margin-top:6px">
    <small id="countdown"></small><br>
    <small>Źródło terminarza: <a href="https://plk.pl/terminarz/najblizsze-mecze" target="_blank" rel="noreferrer">plk.pl – Najbliższe mecze</a></small><br>
    <small>Ostatnia aktualizacja matches.json: 2026-01-11</small>
  </div>
</div>

<div class="box" id="result"></div>

<div class="box">
  <h3>Historia</h3>
  <div id="history"></div>
</div>

<script>
function normName(s) {
  return String(s || "")
    .trim()
    .replace(/\s+/g, " ")
    .replace(/–/g, "-")
    .replace(/—/g, "-");
}

let teams = null;
let matches = [];

function setStatus(text, ok) {
  const el = document.getElementById('status');
  el.textContent = text;
  el.className = ok ? 'ok' : 'bad';
}

async function loadTeams() {
  const r = await fetch('teams.json', { cache: 'no-store' });
  if(!r.ok) throw new Error('teams.json HTTP ' + r.status);
  teams = await r.json();
}

async function loadMatches() {
  const r = await fetch('matches.json', { cache: 'no-store' });
  if(!r.ok) throw new Error('matches.json HTTP ' + r.status);
  matches = await r.json();
}

function populateTeamSelects() {
  const a = document.getElementById('teamA');
  const b = document.getElementById('teamB');
  a.innerHTML = '';
  b.innerHTML = '';
  Object.keys(teams || {}).forEach(t => {
    a.innerHTML += `<option>${t}</option>`;
    b.innerHTML += `<option>${t}</option>`;
  });
}

function updateMatchList() {
  const host = normName(document.getElementById('teamA').value);
  const ms = document.getElementById('matchSelect');
  ms.innerHTML = `<option value="">— wybierz mecz —</option>`;

  const upcoming = matches
    .filter(m => normName(m.home) === host)
    .sort((x,y) => new Date(x.start) - new Date(y.start));

  if (upcoming.length === 0) {
    ms.innerHTML += `<option value="">(Brak meczów dla: ${host} – zaktualizuj matches.json)</option>`;
  } else {
    for (const m of upcoming) {
      const d = new Date(m.start);
      const label = `${d.toLocaleString('pl-PL')} — vs ${m.away} (kolejka ${m.round})`;
      ms.innerHTML += `<option value="${m.id}">${label}</option>`;
    }
  }

  document.getElementById('btnPredict').disabled = true;
  document.getElementById('countdown').textContent = '';
  document.getElementById('matchDate').value = '';
}

function applySelectedMatch() {
  const id = document.getElementById('matchSelect').value;
  const m = matches.find(x => String(x.id) === String(id));
  if(!m) {
    document.getElementById('btnPredict').disabled = true;
    return;
  }

  // ustaw gościa + datę
  document.getElementById('teamB').value = m.away;

  const dt = new Date(m.start);
  const pad = n => String(n).padStart(2,'0');
  const val = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
  document.getElementById('matchDate').value = val;

  updateCountdown(dt);
  document.getElementById('btnPredict').disabled = false;
}

function updateCountdown(matchTime) {
  const el = document.getElementById('countdown');
  const now = new Date();
  const diffMs = matchTime - now;

  if(diffMs > 0) {
    const totalSec = Math.floor(diffMs / 1000);
    const days = Math.floor(totalSec / 86400);
    const hours = Math.floor((totalSec % 86400) / 3600);
    const mins = Math.floor((totalSec % 3600) / 60);
    el.textContent = `Start za: ${days}d ${hours}h ${mins}m`;
  } else {
    el.textContent = `Mecz już się rozpoczął / minął`;
  }
}

function teamScore(name, isHome) {
  const t = teams[name];
  if(!t) return 50;
  const base = t.rating;
  const form = (t.form.reduce((a,v)=>a+v,0)/5) * 20;
  const players = t.top_players.reduce((s,p)=>s+(p.ppg*0.5+p.rpg*0.3+p.apg*0.2),0) * 0.4;
  const homeBonus = isHome ? 6 : 0;
  const rand = Math.random()*3;
  return base + form + players + homeBonus + rand;
}

function predict() {
  const a = document.getElementById('teamA').value; // gospodarz
  const b = document.getElementById('teamB').value; // gość
  const dtVal = document.getElementById('matchDate').value;

  if(!a || !b || a === b) {
    result.innerHTML = "Wybierz mecz z terminarza.";
    return;
  }

  const sa = teamScore(a, true);
  const sb = teamScore(b, false);
  const diff = sa - sb;
  const win = diff > 0 ? a : b;
  const pct = Math.min(80, 50 + Math.abs(diff) * 2.3);
  const conf = pct > 70 ? "WYSOKA" : pct > 60 ? "ŚREDNIA" : "NISKA";

  let when = "";
  if(dtVal) when = `<br><b>Mecz:</b> ${new Date(dtVal).toLocaleString('pl-PL')}`;

  result.innerHTML = `
    <h3>WYNIK ANALIZY</h3>
    ${a}: ${sa.toFixed(1)}<br>
    ${b}: ${sb.toFixed(1)}<br><br>
    <b>Typ:</b> ${win}<br>
    <b>Szanse:</b> ${pct.toFixed(0)}%<br>
    <b>Pewność:</b> ${conf}
    ${when}
    <br><small>Do zabawy</small>
  `;

  history.innerHTML = `${a} vs ${b} → ${win} (${pct.toFixed(0)}%)${dtVal ? " | " + new Date(dtVal).toLocaleString('pl-PL') : ""}<br>` + history.innerHTML;
}

(async () => {
  try {
    await Promise.all([loadTeams(), loadMatches()]);
    setStatus("ONLINE: dane + terminarz załadowane", true);
  } catch(e) {
    console.warn(e);
    setStatus("OFFLINE: błąd ładowania danych (teams.json / matches.json)", false);
    return;
  }

  populateTeamSelects();
  updateMatchList();

  document.getElementById('teamA').addEventListener('change', updateMatchList);
  document.getElementById('matchSelect').addEventListener('change', applySelectedMatch);
})();
</script>
</body>
</html>
